<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Traduction des Recettes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen flex flex-col bg-gray-100 font-sans">

    <header class="px-10 py-6 flex justify-between items-center">
        <h1 class="text-3xl font-bold text-green-700">Glodon üçÉ </h1>
        <nav class="flex space-x-6 text-gray-700">
            <a href="dashboard.html" class="transition-colors duration-300 hover:text-green-600">Accueil</a>
            <a href="#" class="transition-colors duration-300 hover:text-green-600">Param√®tres</a>
            <a href="#" class="transition-colors duration-300 hover:text-green-600">Contact</a>
          </nav>
      </header>

  <main class="flex-grow container mx-auto p-6">
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6" id="recipe-container">
      <!-- Les cartes de recettes seront inject√©es ici -->
    </div>
  </main>

  <footer class="bg-gray-800 text-white py-6 text-center">
    <p>&copy; 2023 Glodon. Tous droits r√©serv√©s.</p>
    <p>D√©velopp√© avec ‚ù§Ô∏è par [Votre Nom]</p>
  </footer>

  <!-- Formulaire de traduction en modale -->
  <div id="modal-traduction" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white p-6 rounded-lg shadow-xl max-w-xl w-full relative">
      <button id="close-modal" class="absolute top-2 right-2 text-gray-500 hover:text-red-600 text-xl">&times;</button>
      <h2 class="text-2xl font-semibold mb-4 text-center">Traduire la recette</h2>

      <form id="form-traduction" class="space-y-4">
        <input type="hidden" id="recette-id" />

        <div>
          <label class="block text-sm font-medium text-gray-700">Nom traduit</label>
          <input id="trad-name" type="text" class="w-full border border-gray-300 rounded p-2" required>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">Ingr√©dients (quantit√© nom type, un par ligne)</label>
          <textarea id="trad-ingredients" class="w-full border border-gray-300 rounded p-2 h-24" required></textarea>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">√âtapes (une par ligne)</label>
          <textarea id="trad-steps" class="w-full border border-gray-300 rounded p-2 h-24" required></textarea>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">Restrictions (s√©par√©es par des virgules)</label>
          <input id="trad-without" type="text" class="w-full border border-gray-300 rounded p-2" required>
        </div>

        <button type="submit" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 transition">
          Enregistrer la traduction
        </button>
      </form>
    </div>
  </div>

  <script>
    const modal = document.getElementById('modal-traduction');
    const closeModalBtn = document.getElementById('close-modal');
    const form = document.getElementById('form-traduction');
    const recetteIdInput = document.getElementById('recette-id');
    const webServerAddress = "http://localhost:8080";

async function getRecipes() {
    try {
        const response = await fetch(`${webServerAddress}/recipes`, {
            method: "GET",
        });

        if (response.ok) {
            const result = await response.json();
            console.log("Recipes retrieved successfully:", result);
            return result;
        } else {
            console.error("Recipes retrieval failed:", response.status, response.statusText);
        }
    } catch (error) {
        console.error("Error occurred:", error);
    }
}


    async function chargerRecettes() {
        const recettes = await getRecipes();

      const container = document.getElementById('recipe-container');

      recettes.forEach(recette => {
        const card = document.createElement('div');
        card.className = "bg-white rounded-xl shadow-md overflow-hidden hover:shadow-lg transition-all duration-300";

        const dejaTraduite = recette.traductions ? true : false;
        const restrictions = recette.Sans || recette.Without || [];

        card.innerHTML = `
          <img src="${recette.imageURL || 'https://via.placeholder.com/300'}" alt="Image" class="w-full h-48 object-cover">
          <div class="p-4">
            <h3 class="text-lg font-semibold text-gray-800">${recette.nameFR || recette.name}</h3>
            <p class="text-sm text-gray-600 mt-1">Auteur : ${recette.Author || 'Inconnu'}</p>
            <p class="text-sm text-gray-600 mt-1">Restrictions : ${restrictions.join(', ')}</p>
            <p class="text-xs text-${dejaTraduite ? 'green' : 'red'}-600 mt-2">
              ${dejaTraduite ? '‚úÖ Traduction existante' : '‚õî Non traduite'}
            </p>
            <button data-id="${recette.id}" data-name="${recette.nameFR || recette.name}" class="btn-traduire mt-3 bg-blue-500 text-white py-1 px-4 rounded hover:bg-blue-600 text-sm">
              Traduire
            </button>
          </div>
        `;

        container.appendChild(card);
      });

      document.querySelectorAll('.btn-traduire').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.dataset.id;
          const recettes = await getRecipes();
          const recette = recettes.find(r => r.id == id);

          recetteIdInput.value = recette.id;
          document.getElementById('trad-name').value = recette.nameFR || recette.name;
          document.getElementById('trad-ingredients').value = (recette.ingredientsFR || recette.ingredients || []).map(ing => `${ing.quantity} ${ing.name || ''} ${ing.type}`).join("\n");
          document.getElementById('trad-steps').value = (recette.stepsFR || recette.steps || []).join("\n");
          document.getElementById('trad-without').value = (recette.Sans || recette.Without || []).join(', ');

          modal.classList.remove('hidden');
        });
      });
    }

    closeModalBtn.addEventListener('click', () => {
      modal.classList.add('hidden');
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = recetteIdInput.value;
      const name = document.getElementById('trad-name').value;
      const ingredients = document.getElementById('trad-ingredients').value
        .split("\n")
        .map(l => {
          const [quantity, ...rest] = l.trim().split(" ");
          const type = rest.pop();
          const name = rest.join(" ");
          return { quantity, name, type };
        });

      const steps = document.getElementById('trad-steps').value.split("\n").map(s => s.trim());
      const Without = document.getElementById('trad-without').value.split(",").map(w => w.trim());

      const res = await fetch(`/recipes/${id}/traduction`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, ingredients, steps, Without })
      });

      if (res.ok) {
        alert("‚úÖ Traduction enregistr√©e !");
        modal.classList.add('hidden');
        location.reload();
      } else {
        alert("‚ùå Erreur lors de l'enregistrement.");
      }
    });

    chargerRecettes();
  </script>
</body>
</html>